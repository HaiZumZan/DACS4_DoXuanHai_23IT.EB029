<!DOCTYPE html>
<html lang="vi" class="h-full bg-gray-900">
<head>
    <meta charset="UTF-8">
    <title>Receiver - Xem & Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="flex flex-col h-full text-white bg-black overflow-hidden">

<header class="bg-gray-800 p-3 flex justify-between items-center z-10 shadow-md shrink-0">
    <div class="flex flex-col">
        <div class="flex items-center gap-2">
            <h1 class="font-bold text-lg text-green-400">RECEIVER</h1>
            <span class="text-gray-400 text-sm">| B·∫°n: <b id="myName">...</b></span>
        </div>
        <div class="text-sm text-gray-300">
            ƒêang xem: <b id="senderName" class="text-yellow-400">ƒêang ch·ªù...</b>
        </div>
    </div>
    <button onclick="exitRoom()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded font-bold transition">
        üö™ Tho√°t
    </button>
</header>

<div class="flex flex-1 overflow-hidden">

    <div class="flex-1 relative flex items-center justify-center bg-black">
        <video id="remoteScreen" autoplay playsinline controls class="max-w-full max-h-full object-contain"></video>

        <video id="remoteCamera" autoplay playsinline class="absolute bottom-4 left-4 w-48 h-36 bg-black border border-gray-600 rounded-lg object-cover hidden z-20 shadow-lg"></video>

        <div id="status" class="absolute text-gray-500 text-lg pointer-events-none">ƒêang k·∫øt n·ªëi Server...</div>
    </div>

    <div class="w-80 bg-gray-800 border-l border-gray-700 flex flex-col shrink-0">
        <div class="p-3 bg-gray-750 font-bold text-gray-300 border-b border-gray-700 text-center">Tr√≤ chuy·ªán</div>

        <div id="chatBox" class="flex-1 overflow-y-auto p-3 space-y-2 bg-gray-800 scrollbar-hide flex flex-col-reverse">
        </div>

        <div class="p-2 bg-gray-700 border-t border-gray-600">
            <form onsubmit="sendChat(event)" class="flex gap-2">
                <div class="p-2 bg-gray-700 border-t border-gray-600 relative">
                    <div id="emojiPicker" class="hidden absolute bottom-14 left-2 bg-gray-800 border border-gray-600 p-2 rounded-lg shadow-xl grid grid-cols-6 gap-2 z-50 w-64 h-48 overflow-y-auto">
                    </div>

                    <form onsubmit="sendChat(event)" class="flex flex-nowrap items-center gap-2 w-full">
                        <button type="button" onclick="toggleEmoji()" class="shrink-0 text-2xl hover:bg-gray-600 rounded px-1 transition pb-1">
                            üòÄ
                        </button>

                        <input id="chatInput" type="text" placeholder="Chat..." autocomplete="off"
                               class="flex-1 min-w-0 bg-gray-600 text-white px-3 py-2 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 text-sm">

                        <button type="submit" class="shrink-0 bg-blue-600 hover:bg-blue-500 px-3 py-2 rounded text-white font-bold text-sm">
                            ‚û§
                        </button>
                    </form>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // --- CONFIG ---
    const WS_URL = "ws://192.168.101.27:3001"; // S·ª≠a IP

    const query = new URLSearchParams(window.location.search);
    const room = query.get("room") || "demo1";
    const myUsername = query.get("user") || "Kh√°ch";
    const viewerId = "viewer_" + Math.random().toString(36).substr(2, 9);

    document.getElementById('myName').textContent = myUsername;
    const statusEl = document.getElementById('status');
    const chatBox = document.getElementById('chatBox');

    const remoteScreen = document.getElementById('remoteScreen');
    const remoteCamera = document.getElementById('remoteCamera');

    const ws = new WebSocket(WS_URL);
    let pc = null;
    let videoTrackCount = 0; // ƒê·∫øm s·ªë l∆∞·ª£ng track video nh·∫≠n ƒë∆∞·ª£c ƒë·ªÉ ph√¢n chia

    ws.onopen = () => {
        statusEl.textContent = "ƒêang ch·ªù Sender...";
        ws.send(JSON.stringify({ type: "join", room, id: viewerId, username: myUsername }));
    };

    ws.onmessage = async (msg) => {
        const data = JSON.parse(msg.data);
        if (data.target && data.target !== viewerId) return;

        // 1. Chat
        if (data.type === "chat") {
            addChatMessage(data.username, data.content, data.time, false); // Th√™m tham s·ªë data.time
            return;
        }

        // 2. Sender Info
        if (data.type === "join" && data.id === "sender") {
            document.getElementById('senderName').textContent = data.username || "Sender";
        }

        // 3. WebRTC Offer
        if (data.type === "offer") {
            statusEl.textContent = "ƒêang nh·∫≠n t√≠n hi·ªáu...";
            if (pc) pc.close();

            videoTrackCount = 0; // Reset ƒë·∫øm
            remoteCamera.classList.add('hidden');

            pc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});

            // X·ª¨ L√ù TRACK NH·∫¨N ƒê∆Ø·ª¢C (QUAN TR·ªåNG)
            pc.ontrack = (ev) => {
                statusEl.classList.add('hidden');

                if (ev.track.kind === 'video') {
                    videoTrackCount++;
                    if (videoTrackCount === 1) {
                        // Video ƒë·∫ßu ti√™n -> M√†n h√¨nh ch√≠nh
                        remoteScreen.srcObject = new MediaStream([ev.track]);
                    } else {
                        // Video th·ª© hai -> Camera ph·ª•
                        remoteCamera.srcObject = new MediaStream([ev.track]);
                        remoteCamera.classList.remove('hidden');
                    }
                }
                // Audio t·ª± ƒë·ªông ph√°t theo stream c·ªßa video ƒë·∫ßu ti√™n n·∫øu ch√∫ng c√πng stream ID
                // Ho·∫∑c ta c√≥ th·ªÉ g√°n audio track v√†o remoteScreen lu√¥n.
                if (ev.track.kind === 'audio') {
                   if (remoteScreen.srcObject) {
                       remoteScreen.srcObject.addTrack(ev.track);
                   }
                }
            };

            pc.onicecandidate = (e) => {
                if (e.candidate) ws.send(JSON.stringify({ type: 'candidate', candidate: e.candidate, room, id: viewerId }));
            };

            await pc.setRemoteDescription(data.offer);
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            ws.send(JSON.stringify({ type: 'answer', answer, room, id: viewerId }));
        }

        if (data.type === 'candidate' && pc) {
            try { await pc.addIceCandidate(data.candidate); } catch(e){}
        }

        if (data.type === "user_left" && data.id === "sender") {
            alert("Ng∆∞·ªùi chia s·∫ª ƒë√£ tho√°t ph√≤ng!");
            exitRoom();
        }
    };

    // --- X·ª¨ L√ù EMOJI ---
    const emojiPicker = document.getElementById('emojiPicker');
    const chatInput = document.getElementById('chatInput');

    // Danh s√°ch c√°c icon ph·ªï bi·∫øn (B·∫°n c√≥ th·ªÉ th√™m t√πy th√≠ch)
    const emojiList = [
        "üòÄ", "üòÇ", "ü§£", "üòç", "ü•∞", "üòé",
        "üò≠", "üò°", "üò±", "ü§î", "ü§´", "üò¥",
        "üëç", "üëé", "üëå", "‚úåÔ∏è", "üëè", "üôå",
        "‚ù§Ô∏è", "üíî", "üî•", "‚ú®", "üéâ", "üéà",
        "üëÄ", "‚úÖ", "‚ùå", "üëã", "üí©", "üëª",
        "üê∏", "üê∑", "üê±", "üê∂", "üöÄ", "üí°"
    ];

    // H√†m kh·ªüi t·∫°o: ƒê·ªï icon v√†o b·∫£ng
    function initEmoji() {
        emojiPicker.innerHTML = ""; // X√≥a c≈©
        emojiList.forEach(icon => {
            const btn = document.createElement('button');
            btn.textContent = icon;
            btn.className = "text-xl p-1 hover:bg-gray-700 rounded cursor-pointer transition";
            btn.type = "button"; // Quan tr·ªçng ƒë·ªÉ kh√¥ng submit form
            btn.onclick = () => {
                chatInput.value += icon; // Th√™m icon v√†o √¥ nh·∫≠p
                chatInput.focus();
                emojiPicker.classList.add('hidden'); // Ch·ªçn xong th√¨ ·∫©n b·∫£ng
            };
            emojiPicker.appendChild(btn);
        });
    }

    // H√†m b·∫≠t/t·∫Øt b·∫£ng
    function toggleEmoji() {
        const isHidden = emojiPicker.classList.contains('hidden');
        if (isHidden) {
            emojiPicker.classList.remove('hidden');
            initEmoji(); // T·∫°o l·∫°i b·∫£ng ƒë·ªÉ ƒë·∫£m b·∫£o m·ªõi nh·∫•t
        } else {
            emojiPicker.classList.add('hidden');
        }
    }

    // T·ª± ƒë·ªông ·∫©n b·∫£ng emoji khi b·∫•m ra ngo√†i (T√πy ch·ªçn, cho UX t·ªët h∆°n)
    document.addEventListener('click', (e) => {
        if (!emojiPicker.contains(e.target) && !e.target.closest('button[onclick="toggleEmoji()"]')) {
            emojiPicker.classList.add('hidden');
        }
    });

   // --- CHAT FUNCTION ---
    // 1. H√†m l·∫•y ng√†y gi·ªù ƒë·ªãnh d·∫°ng: "20:30 22/11"
    function getNow() {
        const now = new Date();
        const time = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
        const date = now.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' });
        return `${time} ${date}`;
    }
   // 2. H√†m g·ª≠i tin nh·∫Øn (S·ª≠a l·∫°i)
    function sendChat(e) {
        e.preventDefault();
        const input = document.getElementById('chatInput');
        const text = input.value.trim();

        if(!text) return;

        const currentTime = getNow(); // L·∫•y gi·ªù hi·ªán t·∫°i

        // G·ª≠i l√™n Server (Th√™m tr∆∞·ªùng 'time')
        if (ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({
                type: "chat",
                room: room,  // L∆∞u √Ω: ·ªü file share.html bi·∫øn l√† 'room', view.html c≈©ng l√† 'room' (l·∫•y t·ª´ URL)
                username: typeof username !== 'undefined' ? username : myUsername, // X·ª≠ l√Ω bi·∫øn t√™n kh√°c nhau gi·ªØa 2 file
                content: text,
                time: currentTime
            }));

            // Hi·ªán ngay l√™n giao di·ªán c·ªßa m√¨nh
            addChatMessage("T√¥i", text, currentTime, true);

            input.value = "";
            input.focus();
        } else {
            alert("M·∫•t k·∫øt n·ªëi Server!");
        }
    }

    // 3. H√†m hi·ªÉn th·ªã tin nh·∫Øn (S·ª≠a l·∫°i giao di·ªán)
    function addChatMessage(sender, text, time, isMe) {
        // N·∫øu time b·ªã null (tin nh·∫Øn c≈©), l·∫•y gi·ªù hi·ªán t·∫°i b√π v√†o
        if (!time) time = getNow();

        const div = document.createElement('div');
        div.className = `flex flex-col ${isMe ? 'items-end' : 'items-start'} mb-4`;

        // HTML hi·ªÉn th·ªã: T√™n ng∆∞·ªùi g·ª≠i + Th·ªùi gian nh·ªè b√™n c·∫°nh
        div.innerHTML = `
            <div class="flex items-baseline gap-2 mb-1">
                <span class="text-xs font-bold ${isMe ? 'text-blue-300' : 'text-green-400'}">${sender}</span>
                <span class="text-[10px] text-gray-500">${time}</span>
            </div>
            <div class="${isMe ? 'bg-blue-600' : 'bg-gray-700'} text-white px-3 py-2 rounded-lg max-w-[90%] break-words text-sm shadow-sm relative">
                ${text}
            </div>
        `;

        const chatBox = document.getElementById('chatBox');
        chatBox.prepend(div);
    }

    function exitRoom() {
        ws.close();
        window.location.href = "index.html";
    }
</script>
</body>
</html>