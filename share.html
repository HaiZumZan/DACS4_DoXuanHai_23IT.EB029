<!DOCTYPE html>
<html lang="vi" class="h-full bg-gray-900">
<head>
    <meta charset="UTF-8">
    <title>Sender - Chia s·∫ª + Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ·∫®n thanh cu·ªôn cho khung chat */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="flex flex-col h-full text-white bg-black overflow-hidden">

<header class="bg-gray-800 p-3 flex justify-between items-center shadow-md z-10 shrink-0">
    <div class="flex items-center gap-4">
        <h1 class="font-bold text-xl text-blue-400">SENDER</h1>
        <span class="bg-gray-700 px-3 py-1 rounded text-sm text-gray-300">
            Ph√≤ng: <b id="roomName" class="text-white">...</b>
        </span>
    </div>
    <div class="flex gap-3">
        <button id="camBtn" onclick="toggleCamera()" class="bg-gray-600 hover:bg-gray-500 text-white px-3 py-2 rounded font-bold hidden transition flex items-center gap-2">
            <span>üì∑</span> B·∫≠t Cam
        </button>

        <button id="startBtn" onclick="startSharing()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-bold hidden transition flex items-center gap-2">
            <span>üì°</span> B·∫Øt ƒë·∫ßu Live
        </button>
        <button onclick="exitRoom()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded font-bold transition">
            üö™ Tho√°t
        </button>
    </div>
</header>

<div class="flex flex-1 overflow-hidden">

    <div class="flex-1 relative flex items-center justify-center bg-black">
        <video id="screen" autoplay playsinline muted class="max-w-full max-h-full object-contain"></video>

        <video id="localCam" autoplay playsinline muted class="absolute bottom-4 left-4 w-48 h-36 bg-gray-900 border border-gray-600 rounded-lg object-cover hidden z-20 shadow-lg"></video>

        <div id="status" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-gray-500 text-lg pointer-events-none">
            ƒêang k·∫øt n·ªëi Server...
        </div>
    </div>

    <div class="w-80 bg-gray-800 border-l border-gray-700 flex flex-col shrink-0">

        <div class="h-1/3 border-b border-gray-700 flex flex-col">
            <div class="p-3 bg-gray-750 font-bold text-gray-300 flex justify-between">
                <span>Ng∆∞·ªùi xem</span>
                <span id="viewerCount" class="bg-blue-600 px-2 rounded text-xs flex items-center">0</span>
            </div>
            <div id="viewerList" class="flex-1 overflow-y-auto p-2 space-y-2">
            </div>
        </div>

        <div class="flex-1 flex flex-col min-h-0">
            <div class="p-3 bg-gray-750 font-bold text-gray-300 border-b border-gray-700">Tin nh·∫Øn</div>

            <div id="chatBox" class="flex-1 overflow-y-auto p-3 space-y-2 bg-gray-800 scrollbar-hide flex flex-col-reverse">
            </div>

            <div class="p-2 bg-gray-700 border-t border-gray-600">
                <form onsubmit="sendChat(event)" class="flex gap-2">
                    <div class="p-2 bg-gray-700 border-t border-gray-600 relative">
                        <div id="emojiPicker" class="hidden absolute bottom-14 left-2 bg-gray-800 border border-gray-600 p-2 rounded-lg shadow-xl grid grid-cols-6 gap-2 z-50 w-64 h-48 overflow-y-auto">
                        </div>

                        <form onsubmit="sendChat(event)" class="flex flex-nowrap items-center gap-2 w-full">
                            <button type="button" onclick="toggleEmoji()" class="shrink-0 text-2xl hover:bg-gray-600 rounded px-1 transition pb-1">
                                üòÄ
                            </button>

                            <input id="chatInput" type="text" placeholder="Chat..." autocomplete="off"
                                   class="flex-1 min-w-0 bg-gray-600 text-white px-3 py-2 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 text-sm">

                            <button type="submit" class="shrink-0 bg-blue-600 hover:bg-blue-500 px-3 py-2 rounded text-white font-bold text-sm">
                                ‚û§
                            </button>
                        </form>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // --- C·∫§U H√åNH ---
    const WS_URL = "ws://192.168.101.27:3001"; // Thay IP c·ªßa b·∫°n
    const RTC_CONFIG = {iceServers:[{urls:'stun:stun.l.google.com:19302'}]};

    // --- DOM ELEMENTS ---
    const query = new URLSearchParams(window.location.search);
    const room = query.get("room") || "demo1";
    const username = query.get("user") || "Sender";

    document.getElementById('roomName').textContent = room;
    const statusEl = document.getElementById('status');
    const startBtn = document.getElementById('startBtn');
    const camBtn = document.getElementById('camBtn');
    const viewerListEl = document.getElementById('viewerList');
    const viewerCountEl = document.getElementById('viewerCount');
    const chatBox = document.getElementById('chatBox');
    const localCamVideo = document.getElementById('localCam');

    const ws = new WebSocket(WS_URL);

    let localStream = null;   // Ch·ª©a track Screen + Audio + Camera
    let camStream = null;     // Stream ri√™ng c·ªßa Camera ƒë·ªÉ d·ªÖ qu·∫£n l√Ω
    const peers = {};
    const viewerNames = {};

    // --- WEBSOCKET ---
    ws.onopen = () => {
        statusEl.textContent = "S·∫µn s√†ng. B·∫•m 'B·∫Øt ƒë·∫ßu Live'.";
        startBtn.classList.remove('hidden');
        camBtn.classList.remove('hidden');
        ws.send(JSON.stringify({ type: "join", room, id: "sender", username: username }));
    };

    ws.onclose = () => {
        statusEl.textContent = "M·∫•t k·∫øt n·ªëi Server!";
        statusEl.className = "text-red-500 font-bold absolute top-1/2 left-1/2 transform -translate-x-1/2";
    };

    ws.onmessage = async (msg) => {
        const data = JSON.parse(msg.data);
        const viewerId = data.id;

        // 1. Chat
        if (data.type === "chat") {
            addChatMessage(data.username, data.content, data.time, false); // Th√™m tham s·ªë data.time
            return;
        }

        // 2. Viewer Join
        if (data.type === "join" && viewerId && viewerId !== "sender") {
            viewerNames[viewerId] = data.username || "Kh√°ch";
            updateViewerList();
            if (localStream) createPeerConnection(viewerId);
        }

        // 3. Viewer Left
        if (data.type === "user_left") {
            if (peers[viewerId]) { peers[viewerId].close(); delete peers[viewerId]; }
            delete viewerNames[viewerId];
            updateViewerList();
        }

        // 4. WebRTC Signaling
        if (data.type === "answer" && peers[viewerId]) {
            try { await peers[viewerId].setRemoteDescription(data.answer); } catch(e){}
        }
        if (data.type === 'candidate' && peers[viewerId]) {
            try { await peers[viewerId].addIceCandidate(data.candidate); } catch(e){}
        }
    };

    // --- X·ª¨ L√ù EMOJI ---
    const emojiPicker = document.getElementById('emojiPicker');
    const chatInput = document.getElementById('chatInput');

    // Danh s√°ch c√°c icon ph·ªï bi·∫øn (B·∫°n c√≥ th·ªÉ th√™m t√πy th√≠ch)
    const emojiList = [
        "üòÄ", "üòÇ", "ü§£", "üòç", "ü•∞", "üòé",
        "üò≠", "üò°", "üò±", "ü§î", "ü§´", "üò¥",
        "üëç", "üëé", "üëå", "‚úåÔ∏è", "üëè", "üôå",
        "‚ù§Ô∏è", "üíî", "üî•", "‚ú®", "üéâ", "üéà",
        "üëÄ", "‚úÖ", "‚ùå", "üëã", "üí©", "üëª",
        "üê∏", "üê∑", "üê±", "üê∂", "üöÄ", "üí°"
    ];

    // H√†m kh·ªüi t·∫°o: ƒê·ªï icon v√†o b·∫£ng
    function initEmoji() {
        emojiPicker.innerHTML = ""; // X√≥a c≈©
        emojiList.forEach(icon => {
            const btn = document.createElement('button');
            btn.textContent = icon;
            btn.className = "text-xl p-1 hover:bg-gray-700 rounded cursor-pointer transition";
            btn.type = "button"; // Quan tr·ªçng ƒë·ªÉ kh√¥ng submit form
            btn.onclick = () => {
                chatInput.value += icon; // Th√™m icon v√†o √¥ nh·∫≠p
                chatInput.focus();
                emojiPicker.classList.add('hidden'); // Ch·ªçn xong th√¨ ·∫©n b·∫£ng
            };
            emojiPicker.appendChild(btn);
        });
    }

    // H√†m b·∫≠t/t·∫Øt b·∫£ng
    function toggleEmoji() {
        const isHidden = emojiPicker.classList.contains('hidden');
        if (isHidden) {
            emojiPicker.classList.remove('hidden');
            initEmoji(); // T·∫°o l·∫°i b·∫£ng ƒë·ªÉ ƒë·∫£m b·∫£o m·ªõi nh·∫•t
        } else {
            emojiPicker.classList.add('hidden');
        }
    }

    // T·ª± ƒë·ªông ·∫©n b·∫£ng emoji khi b·∫•m ra ngo√†i (T√πy ch·ªçn, cho UX t·ªët h∆°n)
    document.addEventListener('click', (e) => {
        if (!emojiPicker.contains(e.target) && !e.target.closest('button[onclick="toggleEmoji()"]')) {
            emojiPicker.classList.add('hidden');
        }
    });

    // --- LOGIC CHIA S·∫∫ ---
    let isCameraOn = false;

    async function toggleCamera() {
        if (isCameraOn) {
            // T·∫Øt Camera
            if (camStream) {
                camStream.getTracks().forEach(track => track.stop());
                camStream = null;
            }
            localCamVideo.classList.add('hidden');
            camBtn.classList.remove('bg-red-600');
            camBtn.innerHTML = "<span>üì∑</span> B·∫≠t Cam";
            isCameraOn = false;
            // L∆∞u √Ω: T·∫Øt camera khi ƒëang Live s·∫Ω kh√¥ng t·ª± x√≥a track b√™n ph√≠a ng∆∞·ªùi xem trong phi√™n b·∫£n ƒë∆°n gi·∫£n n√†y.
            // H·ªç s·∫Ω th·∫•y h√¨nh camera b·ªã ƒëen ho·∫∑c ƒë·ª©ng.
        } else {
            // B·∫≠t Camera
            try {
                camStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                localCamVideo.srcObject = camStream;
                localCamVideo.classList.remove('hidden');
                camBtn.classList.add('bg-red-600');
                camBtn.innerHTML = "<span>üö´</span> T·∫Øt Cam";
                isCameraOn = true;

                // N·∫øu ƒëang Live, th√™m track camera v√†o stream ch√≠nh
                if (localStream) {
                    camStream.getVideoTracks().forEach(track => {
                        localStream.addTrack(track);
                        // C·∫ßn addTrack v√†o c√°c peer hi·ªán c√≥ (c·∫ßn logic renegotiation ph·ª©c t·∫°p ->
                        // ƒê∆°n gi·∫£n nh·∫•t: Y√™u c·∫ßu ng∆∞·ªùi d√πng b·∫≠t Cam TR∆Ø·ªöC khi b·∫•m Start Live)
                    });
                }
            } catch (e) {
                alert("Kh√¥ng th·ªÉ b·∫≠t Camera: " + e.message);
            }
        }
    }

    async function startSharing() {
        try {
            statusEl.textContent = "ƒêang kh·ªüi t·∫°o...";

            // 1. L·∫•y M√†n h√¨nh
            const screenStream = await navigator.mediaDevices.getDisplayMedia({
                video: { cursor: "always" }, audio: false
            });

            // 2. L·∫•y Micro
            let micStream;
            try {
                micStream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: true } });
            } catch (e) { console.log("Kh√¥ng c√≥ mic"); }

            // 3. G·ªôp Stream (M√†n h√¨nh + Mic)
            const tracks = [...screenStream.getVideoTracks()];
            if (micStream) tracks.push(...micStream.getAudioTracks());

            // 4. N·∫øu Camera ƒë√£ b·∫≠t t·ª´ tr∆∞·ªõc, th√™m v√†o lu√¥n
            if (camStream) {
                tracks.push(...camStream.getVideoTracks());
            } else if (confirm("B·∫°n c√≥ mu·ªën b·∫≠t Camera lu√¥n kh√¥ng?")) {
                await toggleCamera();
                if (camStream) tracks.push(...camStream.getVideoTracks());
            }

            localStream = new MediaStream(tracks);
            document.getElementById('screen').srcObject = localStream;

            statusEl.classList.add('hidden');
            startBtn.classList.add('hidden');

            // X·ª≠ l√Ω khi user b·∫•m "Stop Sharing" c·ªßa tr√¨nh duy·ªát
            screenStream.getVideoTracks()[0].onended = () => exitRoom();

            // K·∫øt n·ªëi ng∆∞·ªùi xem hi·ªán c√≥
            Object.keys(viewerNames).forEach(vid => createPeerConnection(vid));

        } catch (err) {
            alert("L·ªói: " + err.message);
            statusEl.textContent = "L·ªói kh·ªüi t·∫°o media";
        }
    }

    async function createPeerConnection(viewerId) {
        const pc = new RTCPeerConnection(RTC_CONFIG);
        peers[viewerId] = pc;

        // Add t·∫•t c·∫£ tracks (Screen, Mic, Camera)
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

        pc.onicecandidate = (e) => {
            if(e.candidate) ws.send(JSON.stringify({ type: 'candidate', candidate: e.candidate, room, target: viewerId }));
        };

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        ws.send(JSON.stringify({ type: 'offer', offer, room, target: viewerId }));
    }

    // --- CHAT FUNCTION ---
    // 1. H√†m l·∫•y ng√†y gi·ªù ƒë·ªãnh d·∫°ng: "20:30 22/11"
    function getNow() {
        const now = new Date();
        const time = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
        const date = now.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' });
        return `${time} ${date}`;
    }
   // 2. H√†m g·ª≠i tin nh·∫Øn (S·ª≠a l·∫°i)
    function sendChat(e) {
        e.preventDefault();
        const input = document.getElementById('chatInput');
        const text = input.value.trim();

        if(!text) return;

        const currentTime = getNow(); // L·∫•y gi·ªù hi·ªán t·∫°i

        // G·ª≠i l√™n Server (Th√™m tr∆∞·ªùng 'time')
        if (ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({
                type: "chat",
                room: room,  // L∆∞u √Ω: ·ªü file share.html bi·∫øn l√† 'room', view.html c≈©ng l√† 'room' (l·∫•y t·ª´ URL)
                username: typeof username !== 'undefined' ? username : myUsername, // X·ª≠ l√Ω bi·∫øn t√™n kh√°c nhau gi·ªØa 2 file
                content: text,
                time: currentTime
            }));

            // Hi·ªán ngay l√™n giao di·ªán c·ªßa m√¨nh
            addChatMessage("T√¥i", text, currentTime, true);

            input.value = "";
            input.focus();
        } else {
            alert("M·∫•t k·∫øt n·ªëi Server!");
        }
    }

    // 3. H√†m hi·ªÉn th·ªã tin nh·∫Øn (S·ª≠a l·∫°i giao di·ªán)
    function addChatMessage(sender, text, time, isMe) {
        // N·∫øu time b·ªã null (tin nh·∫Øn c≈©), l·∫•y gi·ªù hi·ªán t·∫°i b√π v√†o
        if (!time) time = getNow();

        const div = document.createElement('div');
        div.className = `flex flex-col ${isMe ? 'items-end' : 'items-start'} mb-4`;

        // HTML hi·ªÉn th·ªã: T√™n ng∆∞·ªùi g·ª≠i + Th·ªùi gian nh·ªè b√™n c·∫°nh
        div.innerHTML = `
            <div class="flex items-baseline gap-2 mb-1">
                <span class="text-xs font-bold ${isMe ? 'text-blue-300' : 'text-green-400'}">${sender}</span>
                <span class="text-[10px] text-gray-500">${time}</span>
            </div>
            <div class="${isMe ? 'bg-blue-600' : 'bg-gray-700'} text-white px-3 py-2 rounded-lg max-w-[90%] break-words text-sm shadow-sm relative">
                ${text}
            </div>
        `;

        const chatBox = document.getElementById('chatBox');
        chatBox.prepend(div);
    }

    function updateViewerList() {
        viewerListEl.innerHTML = "";
        const ids = Object.keys(viewerNames);
        viewerCountEl.textContent = ids.length;
        ids.forEach(id => {
            const div = document.createElement('div');
            div.className = "bg-gray-700 p-2 rounded flex items-center gap-2 text-sm";
            div.innerHTML = `<div class="w-2 h-2 bg-green-500 rounded-full"></div> <span>${viewerNames[id]}</span>`;
            viewerListEl.appendChild(div);
        });
    }

    function exitRoom() {
        if(localStream) localStream.getTracks().forEach(t => t.stop());
        ws.close();
        window.location.href = "index.html";
    }
</script>
</body>
</html>